<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAGAWA SECONDARY SCHOOL - Results Portal (GitHub-backed test)</title>
  <style>
    /* ===== CSS from your stylesheet (trimmed for brevity, intact semantics) ===== */
    body {
      font-family: Arial, Helvetica, Tahoma, Geneva, sans-serif;
      margin: 0; padding: 0; background-color: #f4f4f9; color: #333;
    }
    #app-container { max-width: 1200px; margin: 20px auto; border: 1px solid #ccc; background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,.1); min-height: 800px; }
    .page { padding: 20px; display: none; min-height: 760px; }
    .centered { text-align: center; }
    .logo { width: 80px; height: 80px; background: #004d40; margin: 0 auto 15px; border-radius: 5px;
      display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 30px; }
    .control-group { margin-bottom: 20px; }
    input[type="text"], input[type="password"], select, button, textarea {
      font-family: Arial, Helvetica, Tahoma, Geneva, sans-serif; padding: 10px; margin: 5px 0; width: 90%; max-width: 300px;
      display: block; margin-left: auto; margin-right: auto; box-sizing: border-box; border: 1px solid #ccc;
    }
    button { background-color: #007AA5; color: white; border: none; cursor: pointer; font-size: 16px; transition: background-color .3s; border-radius: 8px; }
    button:hover { background-color: #005C8C; }
    .back-btn { float: left; margin-bottom: 10px; width: 100px; max-width: 100px; }
    .portal-btn { width: 90%; max-width: 400px; margin-bottom: 15px; font-size: 18px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid black; }
    th, td { border: 1px solid black; padding: 5px; text-align: center; }
    th { background-color: #f2f2f2; font-weight: bold; }
    #analysisTable th, #analysisTable td { padding: 8px 3px; min-width: 40px; font-size: 11px; }
    #progressReport { background-color: white; color: black; padding: 25px 10px 10px 10px; width: 794px; min-height: 1123px;
      box-shadow: 0 0 10px rgba(0,0,0,.5); margin: 20px auto; page-break-after: always; box-sizing: border-box; position: relative; }
    #progressReport header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    #progressReport header .logo { width: 120px; height: 80px; margin: 0 15px 0 0; background-color: #004d40; border-radius: 5px;
      display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; }
    #reportHeaderRight { text-align: right; font-size: 9pt; }
    #reportHeaderRight h3 { font-size: 16pt; margin: 0 0 5px 0; font-weight: bold; }
    #progressReport h2 { font-size: 14pt; font-weight: bold; }
    #reportDetails { margin: 15px 0; border-bottom: 1px solid black; padding-bottom: 10px; font-size: 10pt; }
    #reportDetails div { display: flex; justify-content: space-between; margin-top: 5px; }
    #resultsTable { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 9pt; }
    #resultsTable th, #resultsTable td { border: 1px solid black; padding: 5px; text-align: left; background-color: white; }
    #resultsTable th { background-color: #eee; text-align: center; font-weight: bold; }
    #resultsTable thead tr th:nth-child(1){width:23%} #resultsTable thead tr th:nth-child(2){width:8%}
    #resultsTable thead tr th:nth-child(3){width:8%} #resultsTable thead tr th:nth-child(4){width:12%}
    #resultsTable thead tr th:nth-child(5){width:30%} #resultsTable thead tr th:nth-child(6){width:19%}
    #gradeKeyTable { width: 100%; border-collapse: collapse; font-size: 9pt; }
    #gradeKeyTable th, #gradeKeyTable td { border: 1px solid black; padding: 3px 5px; text-align: center; background-color: white; vertical-align: middle; }
    #reportSummary { font-size: 9pt; }
    #reportSummary div { margin: 3px 0; font-weight: bold; }
    #reportComment { margin-top: 20px; padding: 10px; border: 1px solid black; font-size: 9pt; height: 30px; overflow: hidden; background-color: white; }
    @media print {
      @page { size: A4 portrait; margin: 1cm; }
      body > .page:not(#progressReport):not(#data-analysis){ display: none !important; }
      #progressReport, #data-analysis { width: auto !important; min-height: auto !important; margin: 0 !important; padding: 10px 20px 20px 20px !important; box-shadow: none !important; display: block !important; }
      #progressReport .back-btn, #progressReport .view-btn, #data-analysis .back-btn, #data-analysis .print-btn { display: none !important; }
    }
  </style>
</head>
<body>
<div id="app-container">
  <!-- ===== FRONT PAGE ===== -->
  <div id="front-page" class="page centered" style="display:block; overflow:hidden;">
    <div class="logo">LOGO PLACEHOLDER</div>
    <div class="title">MAGAWA SECONDARY SCHOOL</div>

    <div class="control-group">
      <label for="f_class_select">Select Class:</label>
      <select id="f_class_select">
        <option value="">-- Select Class --</option>
        <option value="F1">Form 1</option>
        <option value="F2">Form 2</option>
        <option value="F3">Form 3</option>
        <option value="F4">Form 4</option>
      </select>
    </div>
    <div class="control-group">
      <label for="f_student_no">Enter Student Exam Number:</label>
      <input type="text" id="f_student_no" placeholder="e.g., M047/001"/>
    </div>
    <div class="control-group">
      <label for="f_dob">Enter Student DOB (DD/MM/YYYY or YYYY-MM-DD):</label>
      <input type="text" id="f_dob" placeholder="e.g., 01/01/2005"/>
    </div>

    <button id="viewResultsBtn">View Results</button>
    <button onclick="promptLogin('000', 'login-gate')">LOGIN</button>
  </div>

  <!-- ===== LOGIN GATE ===== -->
  <div id="login-gate" class="page">
    <button class="back-btn" onclick="showPage('front-page')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">PORTAL SELECTION</div>
      <button class="portal-btn" onclick="promptLogin('002','teachers-portal')">TEACHERS PORTAL</button>
      <button class="portal-btn" onclick="promptLogin('001','admin-portal')">ADMIN PORTAL</button>
    </div>
  </div>

  <!-- ===== TEACHERS PORTAL ===== -->
  <div id="teachers-portal" class="page">
    <button class="back-btn" onclick="showPage('login-gate')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">TEACHERS PORTAL</div>
      <button class="portal-btn" onclick="showPage('teacher-data-entry')">Data Entry</button>
      <button class="portal-btn" onclick="showPage('score-view')">Score View</button>
      <button class="portal-btn" onclick="showPage('grade-view')">Final Results View (Grade View)</button>
      <button class="portal-btn" onclick="simulateProgressViewSelection()">Progress View</button>
      <button class="portal-btn" onclick="showPage('data-analysis')">Data Analysis</button>
    </div>
  </div>

  <!-- ===== DATA ENTRY ===== -->
  <div id="teacher-data-entry" class="page">
    <button class="back-btn" onclick="showPage('teachers-portal')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">DATA ENTRY</div>
      <p style="color:red;">*Reminder: Teachers must fill their results before deadline.*</p>

      <label for="de_class">Select Class:</label>
      <select id="de_class" style="max-width:400px;"></select>

      <label for="de_subject">Select Subject:</label>
      <select id="de_subject" style="max-width:400px;"></select>

      <label for="de_exam_no">Select/Enter Student Exam No:</label>
      <input type="text" id="de_exam_no" style="max-width:400px;" onkeyup="updateStudentName()"/>

      <label for="de_student_name">Selected Student Name:</label>
      <input type="text" id="de_student_name" value="Student Not Found" readonly style="max-width:400px; background-color:#eee;"/>

      <label for="de_score">Enter Score (0-100):</label>
      <input type="text" id="de_score" placeholder="e.g., 78" style="max-width:400px;"/>

      <label for="de_term">Select Term:</label>
      <select id="de_term" style="max-width:400px;">
        <option>Term 1</option><option selected>Term 2</option><option>Term 3</option>
      </select>

      <label for="de_comments">General Comments (3 lines):</label>
      <textarea id="de_comments" style="max-width:400px; height:60px;" placeholder="Enter comments for the student's progress report..."></textarea>

      <label for="de_token">GitHub Token to Save Data:</label>
      <input type="password" id="de_token" placeholder="Enter Token" style="max-width:400px;"/>

      <button style="max-width:400px;" onclick="submitScore()">Submit Score</button>
    </div>
  </div>

  <!-- ===== ADMIN PORTAL ===== -->
  <div id="admin-portal" class="page">
    <button class="back-btn" onclick="showPage('login-gate')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">ADMIN PORTAL</div>
      <button class="portal-btn" onclick="showPage('admin-repo-management')">Upload/Delete CSV Files</button>
      <button class="portal-btn" onclick="showPage('admin-teacher-assignment')">Assign Teachers to Subjects</button>
      <hr style="width:400px; margin:20px auto;">
      <button class="portal-btn" onclick="simulateProgressViewSelection()">Progress View</button>
      <button class="portal-btn" onclick="showPage('score-view')">Score View</button>
      <button class="portal-btn" onclick="showPage('grade-view')">Final Results View (Grade View)</button>
      <button class="portal-btn" onclick="showPage('data-analysis')">Data Analysis</button>
    </div>
  </div>

  <!-- ===== ADMIN: REPO MGMT ===== -->
  <div id="admin-repo-management" class="page">
    <button class="back-btn" onclick="showPage('admin-portal')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">GITHUB REPO MANAGEMENT</div>
      <p style="color:blue;">Upload a CSV (Exam No, Student’s Name, DOB) to students JSON in your repo.</p>

      <label for="repo_class">Select Class for File:</label>
      <select id="repo_class" style="max-width:400px;"></select>

      <label>Select CSV File (Exam No, Name, DOB):</label>
      <input type="file" id="csv_file" accept=".csv" style="max-width:400px; border:none;"/>

      <label for="repo_token">GitHub Token:</label>
      <input type="password" id="repo_token" placeholder="Enter GitHub Token (mgs, magawass)" style="max-width:400px;"/>

      <button style="max-width:400px;" onclick="handleFileUpload()">Confirm Upload</button>
    </div>
  </div>

  <!-- ===== ADMIN: TEACHER ASSIGNMENT ===== -->
  <div id="admin-teacher-assignment" class="page">
    <button class="back-btn" onclick="showPage('admin-portal')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">TEACHER ASSIGNMENT</div>
      <label for="assign_subject">Select Subject:</label>
      <select id="assign_subject" style="max-width:400px;"></select>
      <label for="assign_teacher">Teacher Name:</label>
      <input type="text" id="assign_teacher" placeholder="e.g., Mr. Banda" style="max-width:400px;"/>
      <button style="max-width:400px;" onclick="handleTeacherAssignment()">Confirm Assignment</button>
    </div>
  </div>

  <!-- ===== SCORE VIEW ===== -->
  <div id="score-view" class="page">
    <button class="back-btn" onclick="showPage('teachers-portal')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">SCORE VIEW</div>
      <label for="sv_class">Select Class:</label>
      <select id="sv_class" style="max-width:300px;"></select>
      <button style="max-width:300px;" onclick="updateViewTable('score-view','sv_class', (cls)=>updateScoreViewTable(cls, document.getElementById('repo_token').value.trim()))">View Scores</button>

      <table style="margin-top:20px;">
        <thead>
        <tr>
          <th style="width:8%;">Exam No</th>
          <th style="width:15%;">STUDENT’S NAME</th>
          <th style="width:6%;">Agri</th>
          <th style="width:6%;">BK</th>
          <th style="width:6%;">Bio</th>
          <th style="width:6%;">Chem</th>
          <th style="width:6%;">Chichewa</th>
          <th style="width:6%;">Eng</th>
          <th style="width:6%;">Geo</th>
          <th style="width:6%;">Hist</th>
          <th style="width:6%;">Math</th>
          <th style="width:6%;">Phy</th>
          <th style="width:6%;">Social</th>
        </tr>
        </thead>
        <tbody id="scoreViewBody">
        <tr><td colspan="13">Select a class and click "View Scores" to see data.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== GRADE VIEW ===== -->
  <div id="grade-view" class="page">
    <button class="back-btn" onclick="showPage('teachers-portal')">Back</button>
    <div class="centered" style="padding-top:50px;">
      <div class="title">GRADE VIEW</div>
      <label for="gv_class">Select Class:</label>
      <select id="gv_class" style="max-width:300px;"></select>
      <button style="max-width:300px;" onclick="updateViewTable('grade-view','gv_class', (cls)=>updateGradeViewExample(cls, document.getElementById('repo_token').value.trim()))">View Grades</button>

      <table style="margin-top:20px;">
        <thead>
        <tr>
          <th style="width:8%;">Exam No</th>
          <th style="width:15%;">STUDENT’S NAME</th>
          <th style="width:5%;">Agri</th>
          <th style="width:5%;">BK</th>
          <th style="width:5%;">Bio</th>
          <th style="width:5%;">Chem</th>
          <th style="width:5%;">Chichewa</th>
          <th style="width:5%;">Eng</th>
          <th style="width:5%;">Geo</th>
          <th style="width:5%;">Hist</th>
          <th style="width:5%;">Math</th>
          <th style="width:5%;">Phy</th>
          <th style="width:5%;">Social</th>
          <th style="width:7%;">Aggregate/Total</th>
        </tr>
        </thead>
        <tbody id="gradeViewBody">
        <tr><td colspan="14">Select a class and click "View Grades" to see data.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== DATA ANALYSIS ===== -->
  <div id="data-analysis" class="page">
    <button class="back-btn" onclick="showPage('teachers-portal')">Back</button>
    <div class="centered" style="padding-top:50px; max-width:1000px; margin:0 auto;">
      <div class="title">DATA ANALYSIS</div>
      <div style="display:flex; justify-content:center; gap:20px; max-width:600px; margin:0 auto 30px;">
        <label for="da_class" style="display:flex; align-items:center; gap:10px;">Select Class:</label>
        <select id="da_class" style="max-width:200px;"></select>
        <button style="max-width:150px;" onclick="updateViewTable('data-analysis','da_class', (cls)=>updateDataAnalysisTable(cls, document.getElementById('repo_token').value.trim()))">View Analysis</button>
        <button class="print-btn" onclick="window.print()" style="max-width:150px;">Print Report</button>
      </div>
      <div id="analysisTableContainer">
        <p style="margin-top:30px;">
          *Analysis Section Placeholder*<br>
          Select a class and click "View Analysis" to generate the report.
        </p>
      </div>
    </div>
  </div>

  <!-- ===== PROGRESS REPORT ===== -->
  <div id="progressReport" class="page" style="display:none;">
    <button class="back-btn" style="position:absolute; top:20px; left:20px;" onclick="showPage('front-page')">Back</button>
    <button class="view-btn" onclick="window.print()" style="position:absolute; top:20px; right:20px; width:100px; max-width:100px;">Print Report</button>
    <div style="clear:both;"></div>

    <header>
      <div style="display:flex; align-items:center;">
        <div class="logo">LOGO</div>
      </div>
      <div id="reportHeaderRight">
        <h3>MAGAWA SECONDARY SCHOOL</h3>
        Private Bag 17,<br>Magawa,<br>Mchinji.
      </div>
    </header>
    <hr style="border-top:2px solid black; margin:10px 0;">
    <div style="margin-bottom:10px;">
      <h2 style="margin:0;">PROGRESS REPORT</h2>
    </div>

    <div id="reportDetails">
      <div>
        <p><strong>STUDENT NAME:</strong> <span id="reportStudentName"></span></p>
        <p><strong>Exam No:</strong> <span id="reportExamNo"></span></p>
      </div>
      <div>
        <p><strong>FORM:</strong> <span id="reportForm"></span></p>
        <p><strong>TERM:</strong> <span id="reportTerm">Term 2</span></p>
      </div>
    </div>

    <table id="resultsTable">
      <thead>
      <tr>
        <th>SUBJECT</th>
        <th>SCORE</th>
        <th>GRADE</th>
        <th>POSITION</th>
        <th>REMARKS</th>
        <th>TEACHER</th>
      </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>

    <div id="summaryAndKeyWrapper" style="display:flex; justify-content:space-between; margin-top:20px;">
      <div id="reportSummary" style="width:48%; border:1px solid black; padding:5px;">
        <div style="text-align:center; margin-bottom:5px; font-size:10pt;">SUMMARY FOR <span id="reportSummaryClassText"></span></div>
        <hr style="border-top:1px solid black; margin:3px 0;">
        <div><p>TOTAL SCORE:</p> <p id="reportSummaryTotalScore">0</p></div>
        <div><p>AVERAGE SCORE:</p> <p id="reportSummaryAverageScore">0.0</p></div>
        <div><p>OVERALL RANK:</p> <p id="reportSummaryOverallRank">-</p></div>
        <div><p>OVERALL REMARK:</p> <p id="reportSummaryOverallRemark">-</p></div>
        <div><p>AGGREGATE (F3/F4):</p> <p id="reportSummaryAggregate">N/A</p></div>
      </div>

      <div id="reportGradeKey" style="width:48%; border:1px solid black; padding:5px;">
        <div style="text-align:center; margin-bottom:5px; font-size:10pt;">GRADE KEY FOR <span id="reportGradeKeyFor"></span></div>
        <hr style="border-top:1px solid black; margin:3px 0;">
        <table id="gradeKeyTable">
          <thead><tr><th>SCORE</th><th>GRADE</th><th>REMARK</th></tr></thead>
          <tbody id="reportGradeScaleBody"></tbody>
        </table>
      </div>
    </div>

    <div id="reportComment">
      No comment available.
    </div>

    <div style="margin-top:50px; display:flex; justify-content:space-between; font-size:10pt;">
      <div style="width:30%; text-align:center;">
        <hr style="border-top:1px solid black; margin-bottom:5px;">CLASS TEACHER
      </div>
      <div style="width:30%; text-align:center;">
        <hr style="border-top:1px solid black; margin-bottom:5px;">HEAD TEACHER
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const OWNER = "magawass";
  const REPO = "mgs";
  const BASE = `https://api.github.com/repos/magawass/mgs/contents/data/students/F3.json
;
  const ALL_SUBJECTS = ["Agriculture","Bible Knowledge","Biology","Chemistry","Chichewa","English","Geography","History","Mathematics","Physics","Social"];
  const CLASSES = ["F1","F2","F3","F4"];
  const TERMS = ["Term 1","Term 2","Term 3"];

  // ===== GITHUB HELPERS =====
  function ghHeaders(token) {
    return { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json", "Content-Type": "application/json" };
  }
  async function ghGet(path, token) {
    const res = await fetch(`${BASE}/${path}`, { headers: ghHeaders(token) });
    if (res.status === 404) return null;
    if (!res.ok) throw new Error(`GitHub GET ${path} failed: ${res.status}`);
    return res.json();
  }
  async function ghReadJson(path, token) {
    const meta = await ghGet(path, token);
    if (!meta) return { data: [], sha: null };
    const data = JSON.parse(atob(meta.content));
    return { data, sha: meta.sha };
  }
  async function ghPut(path, jsonData, message, token, currentSha = null) {
    const body = { message: message || "Update data", content: btoa(JSON.stringify(jsonData, null, 2)), sha: currentSha || undefined };
    const res = await fetch(`${BASE}/${path}`, { method: "PUT", headers: ghHeaders(token), body: JSON.stringify(body) });
    if (!res.ok) throw new Error(`GitHub PUT ${path} failed: ${res.status}`);
    return res.json();
  }
  async function ghEnsureWrite(path, token, transform, commitMsg) {
    const { data, sha } = await ghReadJson(path, token);
    const next = transform(Array.isArray(data) ? data : []);
    return ghPut(path, next, commitMsg, token, sha);
  }

  // ===== GRADING LOGIC =====
  function getGradeF12(score){ if(score>=80)return 'A'; if(score>=65)return 'B'; if(score>=55)return 'C'; if(score>=40)return 'D'; return 'F'; }
  function getRemarkF12(grade){ if(grade==='-')return 'N/A'; if(grade==='A')return 'Excellent'; if(grade==='B')return 'Very Good'; if(grade==='C')return 'Good'; if(grade==='D')return 'Satisfactory'; return 'Fail'; }
  function getGradeF34(score){ if(score>=90)return 1; if(score>=80)return 2; if(score>=70)return 3; if(score>=60)return 4; if(score>=55)return 5; if(score>=50)return 6; if(score>=40)return 8; return 9; }
  function getRemarkF34(grade){ if(grade==='-')return 'N/A'; if(grade<=2)return 'Excellent'; if(grade<=4)return 'Very Good'; if(grade<=6)return 'Good'; if(grade===8)return 'Satisfactory'; return 'Fail'; }
  function isSubjectPass(grade,isF12){ if(grade==='-')return false; return isF12 ? (['A','B','C','D'].includes(grade)) : (Number(grade) <= 8); }
  function calculateAggregate(scoresBySubject){
    const grades=[]; ALL_SUBJECTS.forEach(sub=>{ const s=scoresBySubject[sub]||0; if(s>0) grades.push(getGradeF34(s)); });
    if(grades.length<6) return 'N/A'; grades.sort((a,b)=>a-b); const bestSix=grades.slice(0,6); return bestSix.reduce((sum,g)=>sum+g,0);
  }
  function normalizeDob(dob){ if(/^\d{2}\/\d{2}\/\d{4}$/.test(dob)){ const [d,m,y]=dob.split('/'); return `${y}-${m}-${d}`; } return dob; }

  // ===== UI/Navigation =====
  function populateDropdowns(){
    ["de_class","repo_class","sv_class","gv_class","da_class"].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.innerHTML='<option value="">-- Select Class --</option>'; CLASSES.forEach(c=>el.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
    });
    const subjSel=document.getElementById('de_subject'); const assignSel=document.getElementById('assign_subject');
    [subjSel, assignSel].forEach(el=>{
      if(!el) return; el.innerHTML='<option value="">-- Select Subject --</option>';
      ALL_SUBJECTS.forEach(s=>el.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));
    });
  }
  function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.style.display='none'); document.getElementById(id).style.display='block'; }

  function promptLogin(expectedCode, pageId){
    const code = prompt("Enter PIN:");
    if(code === expectedCode){ showPage(pageId); } else if(code){ alert("Invalid PIN."); }
  }

  document.getElementById('viewResultsBtn').addEventListener('click', viewResults);
  window.updateViewTable = function(viewId, selectId, fn){
    const cls=document.getElementById(selectId).value; if(!cls){ alert("Please select a class first."); return; }
    fn(cls);
  };

  // ===== CSV Upload → students JSON =====
  async function handleFileUpload(){
    const cls=document.getElementById('repo_class').value;
    const fileInput=document.getElementById('csv_file');
    const token=document.getElementById('repo_token').value.trim();
    if(!cls) return alert("Select a class.");
    if(!fileInput.files?.length) return alert("Select a CSV file.");
    if(!token) return alert("Enter GitHub token.");
    const text = await fileInput.files[0].text();
    const rows=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const hasHeader=/exam\s*no/i.test(rows[0]) || /student/i.test(rows[0]) || /dob/i.test(rows[0]);
    const dataRows = hasHeader ? rows.slice(1) : rows;
    const students = dataRows.map(line=>{
      const [examNo,name,dob] = line.split(',').map(x=>x.trim());
      if(!examNo || !name || !dob) return null;
      return { examNo: examNo.toUpperCase(), name, dob: normalizeDob(dob) };
    }).filter(Boolean);
    if(!students.length) return alert("No valid rows found.");
    try{
      await ghEnsureWrite(`data/students/${cls}.json`, token, () => students, `Upload ${cls} students (${students.length})`);
      alert(`Uploaded ${students.length} students to data/students/${cls}.json`);
    }catch(e){ alert(`Upload failed: ${e.message}`); }
  }

  // ===== Teacher assignment → data/teachers.json =====
  async function handleTeacherAssignment(){
    const subject=document.getElementById('assign_subject').value;
    const teacher=document.getElementById('assign_teacher').value.trim();
    const token=document.getElementById('repo_token').value.trim();
    if(!token) return alert("Enter GitHub token.");
    if(!subject) return alert("Select a subject.");
    if(!teacher) return alert("Enter teacher name.");
    try{
      await ghEnsureWrite(`data/teachers.json`, token, (arr)=>{
        const data = Array.isArray(arr) ? arr : [];
        const idx=data.findIndex(x=>x.subject===subject);
        const record={subject, teacher};
        if(idx>=0) data[idx]=record; else data.push(record);
        return data;
      }, `Assign ${teacher} to ${subject}`);
      alert("Teacher assignment saved.");
    }catch(e){ alert(`Assignment failed: ${e.message}`); }
  }

  // ===== Student name auto-fill from repo students =====
  async function updateStudentName(){
    const cls=document.getElementById('de_class').value;
    const examNo=document.getElementById('de_exam_no').value.trim().toUpperCase();
    const token=document.getElementById('de_token').value.trim();
    const nameField=document.getElementById('de_student_name');
    if(!cls || !examNo || !token){ nameField.value='Student Not Found'; return; }
    try{
      const { data: students } = await ghReadJson(`data/students/${cls}.json`, token);
      const s = students.find(x=>x.examNo===examNo);
      nameField.value = s ? s.name : 'Student Not Found';
    }catch(e){ nameField.value='Student Not Found'; }
  }

  // ===== Submit score → data/scores/Fx_TermN.json =====
  async function submitScore(){
    const cls=document.getElementById('de_class').value;
    const subject=document.getElementById('de_subject').value;
    const examNo=document.getElementById('de_exam_no').value.trim().toUpperCase();
    const studentName=document.getElementById('de_student_name').value.trim();
    const scoreStr=document.getElementById('de_score').value.trim();
    const term=document.getElementById('de_term').value.replace(/\s+/g,'');
    const comments=document.getElementById('de_comments').value.trim();
    const token=document.getElementById('de_token').value.trim();

    const score=Number(scoreStr);
    if(!token) return alert("Enter GitHub token.");
    if(!cls) return alert("Select class.");
    if(!subject) return alert("Select subject.");
    if(!examNo) return alert("Enter Exam No.");
    if(studentName==='Student Not Found') return alert("Student not found for this class.");
    if(Number.isNaN(score) || score<0 || score>100) return alert("Score must be 0–100.");

    const isF12 = cls==='F1' || cls==='F2';
    const grade = isF12 ? getGradeF12(score) : getGradeF34(score);

    try{
      await ghEnsureWrite(`data/scores/${cls}_${term}.json`, token, (arr)=>{
        const data = Array.isArray(arr) ? arr : [];
        const idx = data.findIndex(r => r.examNo===examNo && r.subject===subject);
        const record = { examNo, name: studentName, subject, class: cls, term: term.replace('Term','Term '), score, grade, comments };
        if(idx>=0) data[idx]=record; else data.push(record);
        return data;
      }, `Update ${examNo} ${subject} (${cls} ${term})`);
      alert("✅ Score saved to GitHub.");
      document.getElementById('de_score').value='';
      document.getElementById('de_comments').value='';
    } catch(e){ alert(`Save failed: ${e.message}`); }
  }

  // ===== Views from repo =====
  async function updateScoreViewTable(classCode, token){
    const tbody=document.getElementById("scoreViewBody");
    tbody.innerHTML=`<tr><td colspan="13">Loading...</td></tr>`;
    try{
      const { data: students } = await ghReadJson(`data/students/${classCode}.json`, token);
      const allScores=[];
      for(const t of ["Term1","Term2","Term3"]){
        const path=`data/scores/${classCode}_${t}.json`;
        try{ const { data } = await ghReadJson(path, token); allScores.push(...data); }catch{}
      }
      if(!students.length){ tbody.innerHTML=`<tr><td colspan="13">No students found for ${classCode}.</td></tr>`; return; }
      const byExam={}; students.forEach(s=>{ byExam[s.examNo]={ examNo:s.examNo, name:s.name }; });
      allScores.forEach(r=>{ if(!byExam[r.examNo]) byExam[r.examNo]={ examNo:r.examNo, name:r.name }; byExam[r.examNo][r.subject]=r.score; });
      const rows=Object.values(byExam).sort((a,b)=>a.examNo.localeCompare(b.examNo));
      tbody.innerHTML="";
      rows.forEach(row=>{
        let cells=`<td>${row.examNo}</td><td style="text-align:left">${row.name||""}</td>`;
        const shortMap = {
          "Agriculture":"Agri","Bible Knowledge":"BK","Biology":"Bio","Chemistry":"Chem","Chichewa":"Chichewa","English":"Eng",
          "Geography":"Geo","History":"Hist","Mathematics":"Math","Physics":"Phy","Social":"Social"
        };
        ALL_SUBJECTS.forEach(sub=>{ const val=row[sub]; cells += `<td>${val!=null?val:"-"}</td>`; });
        tbody.insertAdjacentHTML("beforeend", `<tr>${cells}</tr>`);
      });
    }catch(e){ tbody.innerHTML=`<tr><td colspan="13">Error: ${e.message}</td></tr>`; }
  }

  async function updateGradeViewExample(classCode, token){
    const tbody=document.getElementById("gradeViewBody");
    tbody.innerHTML=`<tr><td colspan="14">Loading...</td></tr>`;
    try{
      const { data: students } = await ghReadJson(`data/students/${classCode}.json`, token);
      const allScores=[];
      for(const t of ["Term1","Term2","Term3"]){
        const path=`data/scores/${classCode}_${t}.json`;
        try{ const { data } = await ghReadJson(path, token); allScores.push(...data); }catch{}
      }
      if(!students.length){ tbody.innerHTML=`<tr><td colspan="14">No students found for ${classCode}.</td></tr>`; return; }
      const isF12 = classCode==="F1" || classCode==="F2";
      const getGrade = isF12 ? getGradeF12 : getGradeF34;
      const byExam={}; students.forEach(s=>{ byExam[s.examNo]={ examNo:s.examNo, name:s.name, subjects:{} }; });
      allScores.forEach(r=>{ if(!byExam[r.examNo]) byExam[r.examNo]={ examNo:r.examNo, name:r.name, subjects:{} }; byExam[r.examNo].subjects[r.subject]=r.score; });
      const rows=Object.values(byExam);
      rows.forEach(row=>{
        row.total = ALL_SUBJECTS.reduce((sum,sub)=>sum+(row.subjects[sub]||0),0);
        row.aggregate = isF12 ? row.total : calculateAggregate(row.subjects);
      });
      rows.sort((a,b)=>b.total-a.total);
      tbody.innerHTML="";
      rows.forEach(row=>{
        let cells=`<td>${row.examNo}</td><td style="text-align:left">${row.name||""}</td>`;
        ALL_SUBJECTS.forEach(sub=>{
          const s=row.subjects[sub]; const g = s ? getGrade(s) : "-";
          cells+=`<td>${g}</td>`;
        });
        cells += `<td>${isF12 ? row.total : row.aggregate}</td>`;
        tbody.insertAdjacentHTML("beforeend", `<tr>${cells}</tr>`);
      });
    }catch(e){ tbody.innerHTML=`<tr><td colspan="14">Error: ${e.message}</td></tr>`; }
  }

  async function updateDataAnalysisTable(classCode, token){
    const container=document.getElementById("analysisTableContainer");
    container.innerHTML=`<p>Loading analysis...</p>`;
    try{
      const allScores=[];
      for(const t of ["Term1","Term2","Term3"]){
        const path=`data/scores/${classCode}_${t}.json`;
        try{ const { data } = await ghReadJson(path, token); allScores.push(...data); }catch{}
      }
      if(!allScores.length){ container.innerHTML=`<p>No scores found for ${classCode}.</p>`; return; }
      const isF12 = classCode==="F1" || classCode==="F2";
      const getGrade = isF12 ? getGradeF12 : getGradeF34;
      const gradeRows = isF12 ? ["A","B","C","D","F"] : ["1","2","3","4","5","6","8","9"];
      const analysis={}; ALL_SUBJECTS.forEach(sub=>{ analysis[sub]={ Total:0, Pass:0, Fail:0 }; gradeRows.forEach(g=>analysis[sub][g]=0); });
      allScores.forEach(r=>{
        const g=getGrade(r.score).toString();
        if(analysis[r.subject]){ analysis[r.subject].Total++; if(analysis[r.subject][g]!=null) analysis[r.subject][g]++; if(isSubjectPass(g,isF12)) analysis[r.subject].Pass++; else analysis[r.subject].Fail++; }
      });
      let html = `<table id="analysisTable"><thead><tr><th>Subject</th>`;
      ALL_SUBJECTS.forEach(sub=>{ html+=`<th>${sub}</th>`; }); html+=`</tr></thead><tbody>`;
      gradeRows.forEach(g=>{ html+=`<tr><td>Grade ${g}</td>`; ALL_SUBJECTS.forEach(sub=>{ html+=`<td>${analysis[sub][g]}</td>`; }); html+=`</tr>`; });
      html+=`<tr><td>Pass</td>`; ALL_SUBJECTS.forEach(sub=>{ html+=`<td>${analysis[sub].Pass}</td>`; }); html+=`</tr>`;
      html+=`<tr><td>Fail</td>`; ALL_SUBJECTS.forEach(sub=>{ html+=`<td>${analysis[sub].Fail}</td>`; }); html+=`</tr></tbody></table>`;
      container.innerHTML=html;
    }catch(e){ container.innerHTML=`<p>Error: ${e.message}</p>`; }
  }

  // ===== Front page student view (authenticate via repo) =====
  async function viewResults(){
    const classCode=document.getElementById('f_class_select').value;
    const examNo=document.getElementById('f_student_no').value.trim().toUpperCase();
    const dobInput=document.getElementById('f_dob').value.trim();
    const token=document.getElementById('repo_token')?.value.trim() || "";
    if(!classCode || !examNo || !dobInput) return alert("Please select a class, enter Exam No, and DOB.");
    try{
      const { data: students } = await ghReadJson(`data/students/${classCode}.json`, token);
      const student = students.find(s=>s.examNo.toUpperCase()===examNo);
      if(!student) return alert("Student not found.");
      const dob = dobInput.includes('/') ? normalizeDob(dobInput) : dobInput;
      if(student.dob !== dob) return alert("DOB does not match our records.");
      const termText=document.getElementById('reportTerm').textContent.trim(); // e.g., 'Term 2'
      const termKey=termText.replace(/\s+/g,''); // 'Term2'
      const { data: scores } = await ghReadJson(`data/scores/${classCode}_${termKey}.json`, token);
      const records=scores.filter(r=>r.examNo.toUpperCase()===examNo);
      if(!records.length) return alert("No scores found yet.");
      await updateProgressViewData(student, records, classCode, termText, token);
      showPage('progressReport');
    }catch(e){ alert(`Error: ${e.message}`); }
  }

  // ===== Progress report (with teacher assignments) =====
  async function updateProgressViewData(student, records, classCode, term, token){
    document.getElementById('reportStudentName').innerText = student.name;
    document.getElementById('reportExamNo').innerText = student.examNo;
    document.getElementById('reportForm').innerText = classCode;
    document.getElementById('reportTerm').innerText = term;
    document.getElementById('reportSummaryClassText').innerText = classCode;
    document.getElementById('reportGradeKeyFor').innerText = classCode;

    let teachers=[]; const teacherBySubject={};
    try{ const { data } = await ghReadJson(`data/teachers.json`, token); teachers = Array.isArray(data) ? data : []; }catch(e){}
    teachers.forEach(t=>teacherBySubject[t.subject]=t.teacher);

    const isF12 = classCode==="F1" || classCode==="F2";
    const getGrade = isF12 ? getGradeF12 : getGradeF34;
    const getRemark = isF12 ? getRemarkF12 : getRemarkF34;

    let resultsHTML=''; let totalScore=0;
    records.forEach(r=>{
      totalScore+=r.score;
      const grade=getGrade(r.score);
      const remark=getRemark(grade);
      const teacher=teacherBySubject[r.subject] || "-";
      resultsHTML += `<tr>
        <td style="text-align:left; font-weight:bold;">${r.subject}</td>
        <td>${r.score}</td>
        <td>${grade}</td>
        <td>-</td>
        <td style="text-align:left;">${remark}</td>
        <td>${teacher}</td>
      </tr>`;
    });
    document.getElementById('reportBody').innerHTML=resultsHTML;

    const scoresBySubject = Object.fromEntries(records.map(r=>[r.subject, r.score]));
    const avg=(totalScore/records.length).toFixed(1);
    const overallRemark = (()=>{
      // Use your pass rule: 6+ passes including English
      let passed=0, englishPass=false;
      ALL_SUBJECTS.forEach(sub=>{
        const s=scoresBySubject[sub]||0;
        if(!s) return;
        const g=isF12 ? getGradeF12(s) : getGradeF34(s);
        if(isSubjectPass(g,isF12)){ passed++; if(sub==='English') englishPass=true; }
      });
      return (passed>=6 && englishPass) ? 'PASS' : 'FAIL';
    })();
    const aggregate = isF12 ? 'N/A' : calculateAggregate(scoresBySubject);

    document.getElementById('reportSummaryTotalScore').innerText=totalScore;
    document.getElementById('reportSummaryAverageScore').innerText=avg;
    document.getElementById('reportSummaryOverallRank').innerText='-';
    document.getElementById('reportSummaryOverallRemark').innerText=overallRemark;
    document.getElementById('reportSummaryAggregate').innerText=aggregate;

    const gradeScaleBody=document.getElementById('reportGradeScaleBody');
    gradeScaleBody.innerHTML = isF12
      ? `<tr><td>80–100</td><td>A</td><td>Excellent</td></tr>
         <tr><td>65–79</td><td>B</td><td>Very Good</td></tr>
         <tr><td>55–64</td><td>C</td><td>Good</td></tr>
         <tr><td>40–54</td><td>D</td><td>Satisfactory</td></tr>
         <tr><td>0–39</td><td>F</td><td>Fail</td></tr>`
      : `<tr><td>90–100</td><td>1</td><td>Distinction</td></tr>
         <tr><td>80–89</td><td>2</td><td>Distinction</td></tr>
         <tr><td>70–79</td><td>3</td><td>Strong Credit</td></tr>
         <tr><td>60–69</td><td>4</td><td>Strong Credit</td></tr>
         <tr><td>55–59</td><td>5</td><td>Credit</td></tr>
         <tr><td>50–54</td><td>6</td><td>Credit</td></tr>
         <tr><td>40–49</td><td>8</td><td>Pass</td></tr>
         <tr><td>0–39</td><td>9</td><td>Fail</td></tr>`;

    const savedComment = records[0]?.comments || "No comment available.";
    document.getElementById('reportComment').innerText = savedComment;
  }

  // ===== Simulate progress view for admin/teacher (choose any student) =====
  async function simulateProgressViewSelection(){
    const token=document.getElementById('repo_token')?.value.trim() || "";
    const cls = prompt("Enter class (F1/F2/F3/F4):","F3"); if(!cls) return;
    try{
      const { data: students } = await ghReadJson(`data/students/${cls}.json`, token);
      if(!students.length) return alert(`No students found in ${cls}.`);
      const example=students[0];
      const examNo = prompt(`Enter Exam No for Progress Report View (e.g., ${example.examNo}):`, example.examNo);
      if(!examNo) return;
      const termText=document.getElementById('reportTerm').textContent.trim();
      const termKey=termText.replace(/\s+/g,'');
      const { data: scores } = await ghReadJson(`data/scores/${cls}_${termKey}.json`, token);
      const records = scores.filter(r=>r.examNo.toUpperCase()===examNo.toUpperCase());
      if(!records.length) return alert("No scores found for that Exam No.");
      await updateProgressViewData({ name: example.name, examNo: examNo.toUpperCase() }, records, cls, termText, token);
      showPage('progressReport');
    }catch(e){ alert(`Error: ${e.message}`); }
  }

  // ===== On load =====
  window.onload = function(){
    populateDropdowns();
    showPage('front-page');
  };
</script>
</body>
</html>

